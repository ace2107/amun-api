apiVersion: v1
kind: Template
metadata:
  name: amun-inspect-buildconfig-HW
  annotations:
    description: A template for BuildConfig to create build on the fly.
    openshift.io/display-name: Amun inspect BuildConfig
    version: 0.0.1
    tags: poc,amun,thoth,ai-stacks
    template.openshift.io/documentation-url: https://github.com/Thoth-Station/
    template.openshift.io/long-description: >
      A template used to create dynamic builds on user requests.
    template.openshift.io/provider-display-name: Red Hat, Inc.
  labels:
    template: amun-inspect-buildconfig-HW
    app: amun
    component: inspect-buildconfig

objects:
  - kind: BuildConfig
    apiVersion: v1
    metadata:
      name: "${AMUN_INSPECTION_ID}"
      labels:
        app: amun
        component: inspect-buildconfig
    spec:
      output:
        to:
          kind: ImageStreamTag
          name: "${AMUN_INSPECTION_ID}:latest"
      source:
        dockerfile: "${AMUN_GENERATED_DOCKERFILE}"
        type: Dockerfile
      resources:
        limits:
          memory: '512Mi'
          cpu: '500m'
        requests:
          memory: ${AMUN_BUILD_CPU}
          cpu: ${AMUN_BUILD_MEMORY}
      strategy:
        type: Docker
      triggers:
        - type: ConfigChange
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: CPU_FAMILY
                    operator: In
                    values:
                      - ${CPU_FAMILY}
                  - key: CPU_MODEL
                    operator: In
                    values:
                      - ${CPU_MODEL}
                  - key: PHYSICAL_CPUS
                    operator: In
                    values:
                      - ${PHYSICAL_CPUS}
                  - key: processor
                    operator: In
                    values:
                      - ${Processor}

parameters:
  - name: AMUN_INSPECTION_ID
    description: Id of inspection that is run.
    displayName: Inspection id
    required: true

  - description: The content of Dockerfile to be built.
    displayName: Generated Dockerfile
    required: true
    name: AMUN_GENERATED_DOCKERFILE

  - name: AMUN_BUILD_CPU
    description: CPU cores requested for running job
    displayName: Job CPU
    default: 500m

  - name: AMUN_BUILD_MEMORY
    description: Memory requested for running job
    displayName: Job Memory
    default: 512Mi

  - name: CPU_FAMILY
    description: Family number of CPU
    displayName: CPU Family
    required: false

  - name: CPU_MODEL
    description: Modelnumber of CPU
    displayName: CPU model
    required: false

  - name: PHYSICAL_CPUS
    description: NUmber of physical CPUS
    displayName: Physical CPUS
    required: false

  - name: Processor
    description: Name of processor
    displayName: Processor
    required: false
